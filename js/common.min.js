/// ZirkaAndry created this fucking code =)
/// You can write me zirkaandry@gmail.com

$(document).ready(function(){

    var
        body = $("body"),
        active = "active",
        browserWidth = body.width(),
        homePageURL = window.location.origin,
        hidden = "hidden";

    var ajaxscript = {ajax_url: '/wp-admin/admin-ajax.php'};


    /// LazyLoading Images
    window.lazySizesConfig = window.lazySizesConfig || {};
    window.lazySizesConfig.customMedia = {
        '--large': '(min-width: 2400px)',
    };

    if (!document.cookie.length) {
        $('.politic_ofCookies').fadeIn();
    }


    //// Menu Icon
    $('.ham').on("click", function () {
        $(this).toggleClass(active);
        $(".mobileWrapper").toggleClass(active);
        $(".bl_nav").toggleClass(active);
        $(".bl_nav__full").toggleClass(active);
        $(".logo_link").toggleClass(active);
    });

    body.on("click", ".btn_gameInfo", function () {
        $(this).closest(".bl_games__item").toggleClass(active);
    });

    // toContactForm Button

    if ($(window).width() > 1490) {

        var toContactForm = $(".toContactForm"),
            toContactFormButton = $(".toContactForm_button"),
            mainContactForm = $("#contactForm");

        if (mainContactForm.length) {
            var heightToContactForm = Math.round(mainContactForm.offset().top);
            awaitBgImgLoad();
        }


        function awaitBgImgLoad() {

            var src = $(".toContactForm_leprechaun").css("background-image");
            src = src.replace(/url\(|\)|"/g,"");

            loadAndRun(src, onload);
            afterToContactFormButtonLoaded ();

            function onload() {
                toContactForm.show();
                afterToContactFormButtonLoaded();
            }
        }

        function loadAndRun(src, resolve, reject) {
            var img = new Image();
            img.onload = resolve;
            img.onerror = reject || function(){
                console.log("Не загрузилась " + src)
            };
            img.src = src;
        }

        function afterToContactFormButtonLoaded (){
            $(window).scroll(function () {
                if ($(this).scrollTop() > 0) {
                    toContactForm.fadeIn(400);
                } else {
                    toContactForm.fadeOut(400);
                }
            });
        }

        toContactFormButton.click(function () {
            $('body,html').animate({
                scrollTop: heightToContactForm
            }, 400);
            return false;
        });

    }


    ////////////// Play GAME

    body.on("click", ".js-playGame", function () {

        $('video').trigger('pause');

        $('body').addClass('unscroll');

        var gameID = homePageURL + '/netgame_games/db.php?game=' + $(this).data("href");
        var gameIDForMob = 'http://' + window.location.host + '/netgame_games/db.php?game=' + $(this).data("href"); /// For mobile Games dosen't work from https server

        // console.log("gameID = " + gameID);
        // console.log("gameIDForMob = " + gameIDForMob);

        // return;

        // if (checkIOS() === true) {
        //     //// If IOS redirect, because game programmers have curve hands
        //     window.location.href = gameIDForMob;
        //     return
        // }

        popupWrapper.html("");

        var
            gameWidth,
            gameHeight;

        if (window.innerWidth / window.innerHeight < 16 / 9) {
            gameWidth = (window.innerWidth * 0.9).toFixed();
            gameHeight = (gameWidth * 9 / 16).toFixed();
        } else {
            gameHeight = (window.innerHeight * 0.9).toFixed();
            gameWidth = (gameHeight / 9 * 16).toFixed();
        }



        // if ($(window).width() / $(window).height() < 1.6 ) {
        //
        //     //////// FIXED BUGS
        //
        //     var srcForMob = $(".js-mobSrc").data("mob-src");
        //
        //     window.location.href = srcForMob;
        //     return
        //
        // }

        var ajaxscript = {ajax_url: '/wp-admin/admin-ajax.php'};

        $.ajax({
            url: ajaxscript.ajax_url,
            dataType: 'json',
            data: {action: 'need_redirect'},
            method: 'get',
            beforeSend: function (response) {

            },
            success: function (response) {
                if(response.success) {
                    var srcForMob = $(".js-mobSrc").data("mob-src");

                    window.location.href = srcForMob;
                    return
                }
            },
            error: function (r) {
                console.log(r.message)
            }
        });


        $(".btn_close__iframe").removeClass(hidden);
        var currentGame = '<iframe class="iframe_game" src="' + gameID + '" width="' + gameWidth + '" height="' + gameHeight + '" frameborder="0" style="border:0" scrolling="no" vspace="0" hspace="0" marginwidth="0" marginheight="0" seamless allowfullscreen></iframe>';

        popup.removeClass(hidden);
        popupWrapper.html(currentGame);


    });


    $(".btn_close__iframe").on("click", function () {
        $(body).removeClass('unscroll');
        $('video').trigger('play');
        popupWrapper.html("");
        $(this).addClass(hidden);
        popup.addClass(hidden);
    });


    /// WORK WITH POPUP

    /// Show Map

    var
        // btnMap = $(".bl_map"),
        // map = '<iframe class="iframe_map" src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d2541.654920380269!2d30.520416987226834!3d50.428900696325016!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x40d4cf1b7b70e1f5%3A0xe9fe0e1a4d1f7aea!2z0YPQuy4g0JLQsNGB0LjQu9C40Y8g0KLRjtGC0Y7QvdC90LjQutCwLCA10JEsINCa0LjQtdCyLCDQo9C60YDQsNC40L3QsCwgMDIwMDA!5e0!3m2!1sru!2sde!4v1550840194329&amp;hl=en&amp;ie=UTF8&amp;t=&amp;z=14&amp;iwloc=B&amp;output=embed" frameborder="0"></iframe>',

        popup = $(".bl_popup"),
        popupWrapper = $(".bl_popup__wrapper");


    // btnMap.on("click", function () {
    //     popup.removeClass(hidden);
    //     popupWrapper.html(map);
    // });


    //// Clearing popup inner
    popup.on("click", function () {
        popupWrapper.empty();
        popup.addClass(hidden);
        $('body').removeClass('unscroll');
    });

    // Close popup on Esc
    body.keydown(function (e) {
        if (e.which === 27) {
            if ($(".bl_popup").length > 0) {
                popupWrapper.empty();
                popup.addClass(hidden);
                $('body').removeClass('unscroll');
            }
        }
    });


    ////////////// COOCKIES POLITIC

    $('.politic_ofCookies__close').on('click', function() {
        politicOfCookies.remove();
    });

    var btnConfirmCookies = $(".js-cookies"),
        politicOfCookies = $("body .politic_ofCookies");

    btnConfirmCookies.one("click", function () {

        $.ajax({
            url: ajaxscript.ajax_url,
            dataType: 'json',
            data: {action: 'set_cookies_confirm'},
            method: 'post',
            beforeSend: function (response) {
                if (response) {
                    // hide coockies
                    politicOfCookies.remove();
                }
            },
            success: function (response) {
                // if (response) {
                //     console.log(response);
                // }
            },
            error: function (r) {
                console.log(r.message)
            }
        });
    });




});



