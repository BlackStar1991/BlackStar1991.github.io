window.onload = function () {

    const
        body = $("body"),
        hidden = "hidden",
        active = "active";


    function changeRegisterMethod(btn, fild) {
        btn.on("click", function () {
            $(".bl_form__text").removeClass(active);
            $(this).addClass(active);
            $(".bl_form__label").addClass(hidden);
            fild.removeClass(hidden);
        });
    }

    changeRegisterMethod($(".btn_email"), $(".label_email"));
    changeRegisterMethod($(".btn_tel"), $(".label_phone"));

    ///// Version browser

    function get_browser() {
        let ua=navigator.userAgent,tem,M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
        if(/trident/i.test(M[1])){
            tem=/\brv[ :]+(\d+)/g.exec(ua) || [];
            return {name:'IE',version:(tem[1]||'')};
        }
        if(M[1]==='Chrome'){
            tem=ua.match(/\bOPR|Edge\/(\d+)/)
            if(tem!=null)   {return {name:'Opera', version:tem[1]};}
        }
        M=M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
        if((tem=ua.match(/version\/(\d+)/i))!=null) {M.splice(1,1,tem[1]);}
        return {
            name: M[0],
            version: M[1]
        };
    }

    const browser = get_browser();

    console.log( browser );



    ///// COUNTER
    function animationCounter() {
        const FONT = {
            '0': 0b011010011001100110010110,
            '1': 0b001001100010001000100111,
            '2': 0b011010010001001001001111,
            '3': 0b111100010010000110010110,
            '4': 0b001001101010111100100010,
            '5': 0b111110001110000110010110,
            '6': 0b011010001110100110010110,
            '7': 0b111100010010010001000100,
            '8': 0b011010010110100110010110,
            '9': 0b011010011001011100010110
        };
        const cnvs = document.querySelector('canvas');
        cnvs.width = 177;
        cnvs.height = 42;

        const d = 6,
            r = d / 2,
            inc = d * 0.8;

        if (body.width() <= 768) {
            cnvs.width = 190;
            cnvs.height = 36;
        }
        if (body.width() <= 600) {
            cnvs.width = 172;
            cnvs.height = 32;
            const d = 4;
        }
        if (body.width() <= 450) {
            cnvs.width = 164;
            cnvs.height = 30;
        }


        cnvs.ctx = cnvs.getContext('2d');
        let counter = 0;

        loop();

        function loop() {

            cnvs.ctx.fillStyle = '#2223';
            cnvs.ctx.fillRect(0, 0, cnvs.width, cnvs.height);
            let idx, rx, x, y, shift, mask, bit,
                cs = String(counter).padStart(7, '1256090');
            for (let i in cs) {
                shift = i * d * 4;
                x = 0;
                y = inc;
                bit = 24;
                if (mask = FONT[cs.charAt(i)]) {
                    while (--bit >= 0) {
                        idx = 23 - bit;
                        if ((idx % 4 === 0) && idx) {
                            x = 0;
                            y += inc;
                        }
                        rx = shift + (x += inc);
                        const gDot = cnvs.ctx.createRadialGradient(
                            rx + r, y + r, r * 0.45, rx + r, y + r, d * 0.58
                        );
                        gDot.addColorStop(0, (mask & (1 << bit)) ? '#0BFF00' : '#00170C');
                        gDot.addColorStop(1, '#0000');
                        cnvs.ctx.fillStyle = gDot;
                        cnvs.ctx.fillRect(rx - r, y - r, d + r, d + r);
                    }
                }
            }
            counter++;
            requestAnimationFrame(loop);
        }


    }

    if (body.width() >= 350) {
        animationCounter();
    }


    /////////// ANIMATION

    const results = {
        machine1: document.querySelector('#machine1Result'),
        machine2: document.querySelector('#machine2Result'),
        machine3: document.querySelector('#machine3Result')
    };
    const el1 = document.querySelector('#machine1');
    const el2 = document.querySelector('#machine2');
    const el3 = document.querySelector('#machine3');

    let finishedNumber = 2;

    let machine1 = new SlotMachine(el1, {
        active: 1,  //////// Какой элемент виден изначально
        spins: 4,
        delay: 500,
        randomize() {
            return finishedNumber;
        }
    });
    let machine2 = new SlotMachine(el2, {
        active: 4,  //////// Какой элемент виден изначально
        spins: 4,
        delay: 500,
        randomize() {
            return finishedNumber;
        }
    });

    let machine3 = new SlotMachine(el3, {
        active: 3,  //////// Какой элемент виден изначально
        spins: 4,
        delay: 500,
        randomize() {
            return finishedNumber;
        }
    });

    const btnStart = $(".js-start");


    btnStart.one("click", function () {

        const mainPhrase = $(".js-mainPhrase"),
            btn_bonus = $(".btn_bonus"),

            timeStep1 = 4000,
            timeStep2 = timeStep1 + 1000,
            timeStep2_1 = timeStep2 - 1000,
            timeStep3 = timeStep2 + 4000;


        /////////////

        /////// Юзер попадает на лендинг и нажимает на кнопку "Старт"
        /////////Слот крутиться, выпадает первая линия("777"). Иконка с бонусом 225 фриспинов меняет цвет(с серого на фиолетовый(на макете видно))


        function stepOne() {
            machine1.shuffle(5);
            machine2.shuffle(6);
            machine3.shuffle(8);

            setTimeout(function () {
                btn_bonus.eq(0).addClass(active);
                mainPhrase.addClass(hidden);
                mainPhrase.eq(1).removeClass(hidden);

            }, timeStep1);
        }

        stepOne();


        //////// СРАЗУ!!! слот начинает крутиться опять и выпадает вторая линия("3 короля"). Иконка с бонусом 150% на 1-й депозит меняет цвет.
        function stepTwo() {

            setTimeout(function () {

                if (body.width() >= 350) {
                    finishedNumber = 0;
                }

                machine1.shuffle(5);
                machine2.shuffle(6);
                machine3.shuffle(5);

                setTimeout(function () {
                    btn_bonus.eq(1).addClass(active);
                    mainPhrase.addClass(hidden);
                    mainPhrase.eq(2).removeClass(hidden);
                }, timeStep2_1);

            }, timeStep2);

        }

        stepTwo();


        // //////////СРАЗУ!!! открывается форма регистрации. Форма регистрация имеет 1 поле для ввода email.


        function stepThree() {

            setTimeout(function () {

                $(".coverLayer").removeClass(hidden).addClass("coverLayer_animation"); /// 200ms
                $(".bl_popup").removeClass(hidden); /// 500ms + d200ms

                // $(".bl_form__input").focus();


            }, timeStep3);
        }

        stepThree();


        ///////////////////////

    });


////////////////

};


